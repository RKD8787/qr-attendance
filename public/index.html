<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Attendance System</title>
    <link rel="stylesheet" href="style.css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="header">
        <h1><big><strong> Dayananda Sagar College Of Engineering</strong></big></h1>
        <h2>Attendance Portal</h2>
    </div>
   <button class="nav-btn active" onclick="logout()" style="position: absolute; top: 20px; right: 20px; background: #dc3545; color: white; border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer;">Logout</button>

    <div class="container">
        <div id="admin-page" class="page active">
            <div class="admin-content">
                <div class="present-count-card">
                    <div class="present-count">Present: <span id="present-count">0</span></div>
                    <h3 id="current-session-title" style="text-align: center; color: #666; margin-bottom: 20px; font-size: 1.2rem; font-weight: 500;">No Active Session</h3>
                    <div class="present-students">
                        <h3>Present Students</h3>
                        <div id="present-students-list"></div>
                    </div>
                </div>

                <div class="qr-section">
                    <h3>Scan to Mark Attendance</h3>
                    <div class="qr-container">
                        <div id="qr-code-container" style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); min-height: 290px; display: flex; align-items: center; justify-content: center;">
                            <p style="color: #999; font-size: 16px; text-align: center; padding: 40px;">Start a new session to generate a QR code.</p>
                        </div>
                    </div>
                    <p class="qr-instruction">Start a session to generate a new QR code</p>
                </div> 
            </div>

            <div class="action-buttons">
                <button class="add-manually-btn fresh-btn" onclick="showCourseSelectionModal()"><i class="fas fa-rocket"></i> Start New Session</button>
                <button class="add-manually-btn" onclick="showSessionHistoryModal()" style="background: linear-gradient(135deg, #fd7e14, #f86202);"><i class="fas fa-history"></i> Session History</button>
                <button class="add-manually-btn" onclick="showStatisticsModal()" style="background: linear-gradient(135deg, #20c997, #17a67d);"><i class="fas fa-chart-bar"></i> Statistics</button>
                <button class="add-manually-btn" onclick="showAddManuallyModal()"><i class="fas fa-user-plus"></i> Add Attendance Manually</button>
                <button class="add-manually-btn student-list-btn" onclick="showStudentListModal()"><i class="fas fa-users"></i> Manage Students</button>
                <button class="add-manually-btn" onclick="showCoursesModal()" style="background: linear-gradient(135deg, #6f42c1, #5a2d91);"><i class="fas fa-book"></i> Manage Courses</button>
                <button class="add-manually-btn export-btn" onclick="exportAttendanceCSV()"><i class="fas fa-file-csv"></i> Export Attendance</button>
            </div>
        </div>
    </div>

    <div id="add-manually-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Student Manually</h3>
                <button class="close-btn" onclick="closeAddManuallyModal()">&times;</button>
            </div>
            <div class="search-container">
                <input type="text" id="student-search-manual" placeholder="Search for students not yet present...">
                <div class="search-icon">üîç</div>
            </div>
            <div class="student-dropdown" id="student-dropdown"></div>
        </div>
    </div>

    <div id="student-list-modal" class="modal">
        <div class="modal-content student-list-modal-content">
            <div class="modal-header">
                <h3>Manage Student Roster</h3>
                <button class="close-btn" onclick="closeStudentListModal()">&times;</button>
            </div>
            <div class="add-student-section">
                <h4>Add New Student</h4>
                <div class="add-student-form">
                    <input type="text" id="new-student-name" placeholder="Student Name" maxlength="50">
                    <input type="text" id="new-student-usn" placeholder="Unique Student Number (USN)" maxlength="20">
                    <button class="add-student-btn" onclick="addNewStudent()">Add Student</button>
                </div>
            </div>
            <div class="search-container">
                <input type="text" id="student-list-search" placeholder="Search all students...">
                <div class="search-icon">üîç</div>
            </div>
            <div class="student-list-container">
                <div class="student-count-header">Total Students: <span id="total-student-count">0</span></div>
                <div class="student-list-display" id="student-list-display"></div>
            </div>
        </div>
    </div>
    
    <div id="edit-student-modal" class="modal">
        <div class="modal-content student-list-modal-content">
             <div class="modal-header">
                <h3 id="edit-student-title">Edit Student</h3>
                <button class="close-btn" onclick="closeEditStudentModal()">&times;</button>
            </div>
            <div class="edit-student-form">
                <input type="hidden" id="edit-student-original-usn">
                <div>
                    <label for="edit-student-name">Student Name</label>
                    <input type="text" id="edit-student-name" placeholder="Student Name">
                </div>
                <div>
                    <label for="edit-student-usn">Student USN</label>
                    <input type="text" id="edit-student-usn" placeholder="Unique Student Number">
                </div>
                <button class="add-student-btn" onclick="saveStudentDetails()">Save Changes</button>
            </div>
            <hr>
            <h4><i class="fas fa-fingerprint"></i> Registered Fingerprints</h4>
            <div id="student-fingerprint-list"></div>
        </div>
    </div>

    <div id="session-history-modal" class="modal">
        <div class="modal-content student-list-modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-calendar-alt"></i> Session History by Date</h3>
                <button class="close-btn" onclick="closeSessionHistoryModal()">&times;</button>
            </div>

            <div id="session-list-container">
                <div class="session-toolbar">
                    <div class="search-container" style="width: 100%;">
                        <input type="text" id="session-history-search" placeholder="Search sessions...">
                    </div>
                    <div class="toggle-archive">
                        <label for="show-archived">Show Archived:</label>
                        <input type="checkbox" id="show-archived" onchange="fetchAllSessions()">
                    </div>
                </div>
                <div class="student-list-display" id="session-list-display"></div>
            </div>

            <div id="session-details-container" style="display: none;">
                <button class="modal-btn secondary" onclick="backToSessionList()" style="margin-bottom: 15px;">&larr; Back to Session List</button>
                <h4 id="session-details-title"></h4>
                <div class="student-list-display" id="session-details-display"></div>
            </div>
        </div>
    </div>
    
    <div id="courses-modal" class="modal">
        <div class="modal-content student-list-modal-content">
            <div class="modal-header">
                <h3 id="courses-modal-title">Manage Courses</h3>
                <button class="close-btn" onclick="closeCoursesModal()">&times;</button>
            </div>
            <div id="course-list-view">
                <div class="add-student-section">
                    <h4>Create New Course</h4>
                    <div class="add-student-form" style="grid-template-columns: 1fr 1fr auto; gap: 15px;">
                        <input type="text" id="new-course-name" placeholder="Course Name (e.g., Data Structures)" maxlength="100">
                        <input type="text" id="new-course-id" placeholder="Course ID (e.g., CS-101)" maxlength="30">
                        <button class="add-student-btn" onclick="createNewCourse()">Create Course</button>
                    </div>
                    <div style="margin-top: 10px; padding: 10px; background: rgba(0,123,255,0.1); border-radius: 8px; font-size: 14px; color: #666;">
                        <strong>üí° Tip:</strong> Course ID is optional but recommended for easy identification. 
                        Use formats like CS-101, MATH-201, or ENG-301. Leave blank for auto-assignment.
                    </div>
                </div>
                <div class="student-list-display" id="courses-list-display"></div>
            </div>
            <div id="course-management-view" style="display: none;">
                <button class="modal-btn secondary" onclick="backToCoursesList()" style="margin-bottom: 20px;">&larr; Back</button>
                <h4 id="course-management-title"></h4>
                <p><strong>Enrolled Students:</strong></p>
                <div class="student-list-display" id="course-student-list-display" style="margin-top: 10px; max-height: 200px;"></div>
                <hr style="margin: 20px 0;">
                <p><strong>Add Students to Course:</strong></p>
                <input type="text" id="add-student-search" placeholder="Search for students to add..." style="width: 100%; padding: 10px; margin-top: 10px;">
                <div class="student-list-display" id="add-student-to-course-display" style="margin-top: 10px; max-height: 200px;"></div>
                <button class="delete-student-btn" onclick="deleteCourse()" style="width: 100%; margin-top: 20px; padding: 15px; background: #dc3545;">Delete This Course</button>
            </div>
        </div>
    </div>
    
    <div id="statistics-modal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 95vh;">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> Advanced Attendance Statistics</h3>
                <button class="close-btn" onclick="closeStatisticsModal()">&times;</button>
            </div>

            <div class="stats-tabs">
                <button class="stats-tab-btn active" onclick="showStatsTab('overview')">üìä Overview</button>
                <button class="stats-tab-btn" onclick="showStatsTab('sessions')">üóìÔ∏è Session Statistics</button>
                <button class="stats-tab-btn" onclick="showStatsTab('students')">üßë‚Äçüéì Student Statistics</button>
            </div>

            <div id="stats-overview-view" class="stats-view active">
                <div class="overview-grid">
                    <div class="stat-card">
                        <h4>Total Attendance</h4>
                        <p id="stats-total-attendance">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Average Attendance</h4>
                        <p id="stats-avg-attendance">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Total Sessions</h4>
                        <p id="stats-total-sessions">0</p>
                    </div>
                    <div class="stat-card">
                        <h4>Fully Verified</h4>
                        <p id="stats-fully-verified">0%</p>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <h4>Attendance Trend (Last 30 Days)</h4>
                        <canvas id="attendance-trend-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h4>Verification Methods</h4>
                        <canvas id="verification-method-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="stats-sessions-view" class="stats-view">
                <div class="stats-toolbar">
                    <input type="text" id="session-stats-search" class="stats-search" placeholder="Search sessions or courses...">
                </div>
                <div class="stats-list-display" id="session-stats-list"></div>
            </div>

            <div id="stats-students-view" class="stats-view">
                <div class="stats-toolbar">
                    <input type="text" id="student-stats-search" class="stats-search" placeholder="Search students by name or USN...">
                </div>
                <div class="stats-list-display" id="student-stats-list"></div>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
